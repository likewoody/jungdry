{% extends "base.html" %}

{% block content %}
<!--<h2 class="text-2xl font-bold mb-6">세탁기/건조기를 예약해보세요!</h2>-->

<!-- 상태 범례 -->
<div class="flex flex-wrap items-center gap-6 mb-6 px-4 py-3 bg-white rounded-lg shadow-sm">
    <div class="flex items-center">
        <div class="w-4 h-4 bg-green-500 rounded mr-2"></div>
        <span class="text-sm">사용 가능한 세탁기</span>
    </div>
    <div class="flex items-center">
        <div class="w-4 h-4 bg-blue-500 rounded mr-2"></div>
        <span class="text-sm">사용 가능한 건조기</span>
    </div>
    <div class="flex items-center">
        <div class="w-4 h-4 bg-red-500 rounded mr-2"></div>
        <span class="text-sm">사용 중</span>
    </div>
</div>

<!-- 세탁기 섹션 -->
<h2 class="text-xl font-semibold mb-4">세탁기</h2>
<div class="grid grid-cols-7 gap-2 sm:gap-4 mb-8">
    {% for laundry in laundries %}
    {% if laundry.type == 'washer' %}
    <div class="aspect-square"> <!-- 정사각형 비율 유지 -->
        <a href="{{ url_for('reserve', laundry_id=laundry._id) }}"
           class="flex flex-col items-center justify-center h-full rounded-lg shadow-md text-white text-center
                  {% if laundry.status == 0 %}
                  bg-green-500 hover:bg-green-600
                  {% else %}
                  bg-red-500 hover:bg-red-600
                  {% endif %}">
            <span class="text-sm sm:text-base md:text-lg lg:text-xl font-bold">{{ laundry.id }}</span>
            <div class="text-[8px] sm:text-xs md:text-sm mt-1 hidden sm:block"> <!-- 모바일에서는 숨김 -->
                {% if laundry.status == 0 %}
                사용 가능
                {% else %}
                사용 중
                {% endif %}
            </div>
        </a>
    </div>
    {% endif %}
    {% endfor %}
</div>

<!-- 건조기 섹션 -->
<h2 class="text-xl font-semibold mb-4">건조기</h2>
<div class="grid grid-cols-7 gap-2 sm:gap-4 mb-8">
    {% for laundry in laundries %}
    {% if laundry.type == 'dryer' %}
    <div class="aspect-square"> <!-- 정사각형 비율 유지 -->
        <a href="{{ url_for('reserve', laundry_id=laundry._id) }}"
           class="flex flex-col items-center justify-center h-full rounded-lg shadow-md text-white text-center
                  {% if laundry.status == 0 %}
                  bg-blue-500 hover:bg-blue-600
                  {% else %}
                  bg-red-500 hover:bg-red-600
                  {% endif %}">
            <span class="text-sm sm:text-base md:text-lg lg:text-xl font-bold">{{ laundry.id }}</span>
            <div class="text-[8px] sm:text-xs md:text-sm mt-1 hidden sm:block"> <!-- 모바일에서는 숨김 -->
                {% if laundry.status == 0 %}
                사용 가능
                {% else %}
                사용 중
                {% endif %}
            </div>
        </a>
    </div>
    {% endif %}
    {% endfor %}
</div>

<div class="bg-white p-6 rounded-lg shadow-md">
    <h2 class="text-xl font-bold mb-4">이용 안내</h2>
    <ul class="list-disc pl-5 space-y-2">
        <li>세탁기는 1회 사용 시 1시간 단위로 예약할 수 있습니다.</li>
        <li>건조기는 1회 사용 시 2시간 단위로 예약할 수 있습니다.</li>
        <li>녹색 세탁기와 파란색 건조기는 현재 사용 가능한 기기입니다.</li>
        <li>빨간색은 현재 사용 중이거나 예약된 기기입니다.</li>
        <li>오전 0시부터 6시까지는 예약이 불가능합니다.</li>
        <li>예약 취소는 '내 예약' 메뉴에서 가능합니다.</li>
        <li>예약 시간 종료 전 세탁물을 회수하지 않으면, 다음 사용자가 세탁물을 꺼낼 수 있으니 유의해 주시기 바랍니다.</li>
    </ul>
</div>

<script>
// 액세스 토큰 만료 시 처리
async function refreshToken() {
  try {
    const response = await fetch('/api/refresh', {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
      }
    });

    if (!response.ok) {
      // 리프레시 토큰까지 만료되었다면 로그인 페이지로
      window.location.href = '/login';
      return false;
    }

    const data = await response.json();
    return true;
  } catch (error) {
    console.error('토큰 갱신 오류:', error);
    return false;
  }
}

// API 요청 래퍼 함수 (액세스 토큰 만료 자동 처리)
async function fetchWithToken(url, options = {}) {
  // 첫 요청 시도
  let response = await fetch(url, {
    ...options,
    credentials: 'same-origin',
  });

  // 401 Unauthorized - 액세스 토큰 만료
  if (response.status === 401) {
    const refreshSuccess = await refreshToken();
    if (!refreshSuccess) {
      throw new Error('인증이 만료되었습니다. 다시 로그인해주세요.');
    }

    // 새 토큰으로 다시 요청
    response = await fetch(url, {
      ...options,
      credentials: 'same-origin',
    });
  }

  return response;
}
</script>


{% endblock %}